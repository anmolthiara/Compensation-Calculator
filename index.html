<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compensation Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #1f2937;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        h2 {
            color: #4b5563;
            margin-bottom: 20px;
            font-size: 1.25rem;
        }

        .inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .inputs-grid-three {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .inputs-grid-four {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        select {
            transition: border-color 0.2s;
        }

        select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e5e7eb;
        }

        .summary-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 1.75rem;
            font-weight: bold;
        }

        .summary-card:nth-child(1) .summary-value { color: #3b82f6; }
        .summary-card:nth-child(2) .summary-value { color: #10b981; }
        .summary-card:nth-child(3) .summary-value { color: #8b5cf6; }
        .summary-card:nth-child(4) .summary-value { color: #f59e0b; }

        .chart-container {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
        }

        canvas {
            max-height: 400px;
        }

        table {
            width: 100%;
            min-width: 700px;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #d1d5db;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .text-right {
            text-align: right;
        }

        .note {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .note strong {
            color: #1e3a8a;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 5px 0;
        }

        .section-header:hover h2 {
            color: #3b82f6;
        }

        .collapse-icon {
            font-size: 1.5rem;
            color: #6b7280;
            transition: transform 0.3s ease;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’¼ Compensation Calculator</h1>
        
        <div class="inputs-grid-four">
            <!-- Cash Compensation -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('cashCompSection')">
                    <h2>Cash Compensation</h2>
                    <span class="collapse-icon" id="cashCompIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="cashCompSection">
                    <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 15px;">Each year auto-applies 3% raise from previous year</p>
                    
                    <div class="input-group">
                        <label for="baseSalaryYear1">Year 1 Base Salary ($)</label>
                        <input type="number" id="baseSalaryYear1" min="0" step="1000" value="0">
                    </div>

                    <div class="input-group">
                        <label for="bonusYear1">Year 1 Bonus (%)</label>
                        <input type="number" id="bonusYear1" min="0" max="100" step="0.5" value="0">
                    </div>

                    <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;"></div>

                    <div class="input-group">
                        <label for="baseSalaryYear2">Year 2 Base Salary ($)</label>
                        <input type="number" id="baseSalaryYear2" min="0" step="1000" value="0">
                    </div>

                    <div class="input-group">
                        <label for="bonusYear2">Year 2 Bonus (%)</label>
                        <input type="number" id="bonusYear2" min="0" max="100" step="0.5" value="0">
                    </div>

                    <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;"></div>

                    <div class="input-group">
                        <label for="baseSalaryYear3">Year 3 Base Salary ($)</label>
                        <input type="number" id="baseSalaryYear3" min="0" step="1000" value="0">
                    </div>

                    <div class="input-group">
                        <label for="bonusYear3">Year 3 Bonus (%)</label>
                        <input type="number" id="bonusYear3" min="0" max="100" step="0.5" value="0">
                    </div>

                    <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;"></div>

                    <div class="input-group">
                        <label for="baseSalaryYear4">Year 4 Base Salary ($)</label>
                        <input type="number" id="baseSalaryYear4" min="0" step="1000" value="0">
                    </div>

                    <div class="input-group">
                        <label for="bonusYear4">Year 4 Bonus (%)</label>
                        <input type="number" id="bonusYear4" min="0" max="100" step="0.5" value="0">
                    </div>
                </div>
            </div>

            <!-- Stock Prices -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('stockPriceSection')">
                    <h2>Stock Price per Year</h2>
                    <span class="collapse-icon" id="stockPriceIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="stockPriceSection">
                    <div class="input-group">
                        <label for="stockYear1">Year 1 Stock Price ($)</label>
                        <input type="number" id="stockYear1" min="0" step="1" value="0">
                    </div>

                    <div class="input-group">
                        <label for="stockGrowth">Annual Stock Growth (%)</label>
                        <input type="number" id="stockGrowth" min="-100" max="500" step="1" value="0">
                        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 5px;">Auto-calculates Years 2-4 prices (0 = no growth)</p>
                    </div>

                    <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;">
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 10px; font-weight: 500;">Or manually set each year:</p>
                    </div>

                    <div class="input-group">
                        <label for="stockYear2">Year 2 Stock Price ($)</label>
                        <input type="number" id="stockYear2" min="0" step="1" value="0">
                    </div>

                    <div class="input-group">
                        <label for="stockYear3">Year 3 Stock Price ($)</label>
                        <input type="number" id="stockYear3" min="0" step="1" value="0">
                    </div>

                    <div class="input-group">
                        <label for="stockYear4">Year 4 Stock Price ($)</label>
                        <input type="number" id="stockYear4" min="0" step="1" value="0">
                    </div>
                </div>
            </div>

            <!-- RSU Refreshers -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('rsuGrantsSection')">
                    <h2>RSU Grants</h2>
                    <span class="collapse-icon" id="rsuGrantsIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="rsuGrantsSection">
                    <div class="input-group">
                        <label for="initialGrant">Initial Grant (RSUs)</label>
                        <input type="number" id="initialGrant" min="0" step="10" value="0">
                    </div>

                    <div class="input-group">
                        <label for="vestingSchedule">Vesting Schedule</label>
                        <select id="vestingSchedule" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;">
                            <option value="front">Front-loaded (40/30/20/10)</option>
                            <option value="even">Even (25/25/25/25)</option>
                        </select>
                    </div>

                    <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;">
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 10px; font-weight: 500;">Annual Refreshers:</p>
                    </div>
                    
                    <div class="input-group">
                        <label for="refresherYear2">Year 2 Grant (RSUs)</label>
                        <input type="number" id="refresherYear2" min="0" step="10" value="0">
                    </div>

                    <div class="input-group">
                        <label for="refresherYear3">Year 3 Grant (RSUs)</label>
                        <input type="number" id="refresherYear3" min="0" step="10" value="0">
                    </div>

                    <div class="input-group">
                        <label for="refresherYear4">Year 4 Grant (RSUs)</label>
                        <input type="number" id="refresherYear4" min="0" step="10" value="0">
                    </div>

                    <div class="input-group">
                        <label for="refresherVesting">Refresher Vesting % (per year)</label>
                        <input type="number" id="refresherVesting" min="0" max="100" step="1" value="25">
                        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 5px;">% that vests in year granted (typical: 25% for 4-yr vest)</p>
                    </div>
                </div>
            </div>

            <!-- Tax Withholding -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('taxWithholdingSection')">
                    <h2>Tax Withholding</h2>
                    <span class="collapse-icon" id="taxWithholdingIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="taxWithholdingSection">
                    <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 15px;">Optional: Calculate after-tax compensation</p>
                    
                    <div class="input-group">
                        <label for="enableTax">
                            <input type="checkbox" id="enableTax" style="width: auto; margin-right: 8px;">
                            Apply tax withholding
                        </label>
                    </div>

                    <div class="input-group">
                        <label for="filingStatus">Filing Status</label>
                        <select id="filingStatus" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;">
                            <option value="single">Single</option>
                            <option value="married">Married Filing Jointly</option>
                            <option value="head">Head of Household</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="federalTaxRate">Federal Tax Rate (%)</label>
                        <select id="federalTaxRate" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.95rem;">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 5px;">2024 federal tax brackets</p>
                    </div>

                    <div class="input-group">
                        <label for="stateTaxRate">State Tax Rate (%)</label>
                        <input type="number" id="stateTaxRate" min="0" max="20" step="0.5" value="0">
                        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 5px;">CA: ~9-13%, NY: ~4-11%, TX/FL: 0%</p>
                    </div>

                    <div class="input-group">
                        <label for="otherTaxRate">Other Taxes (FICA, etc.) (%)</label>
                        <input type="number" id="otherTaxRate" min="0" max="20" step="0.5" value="7.65">
                        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 5px;">Default: 7.65% for Social Security + Medicare</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-label">Year 1 Total</div>
                <div class="summary-value" id="year1Total">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="year1TotalAfterTax"></div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Year 4 Total</div>
                <div class="summary-value" id="year4Total">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="year4TotalAfterTax"></div>
            </div>
            <div class="summary-card">
                <div class="summary-label">4-Year Total</div>
                <div class="summary-value" id="fourYearTotal">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="fourYearTotalAfterTax"></div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Average Annual</div>
                <div class="summary-value" id="avgAnnual">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="avgAnnualAfterTax"></div>
            </div>
        </div>

        <!-- Stacked Bar Chart -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('stackedChartSection')">
                <h2>Compensation Breakdown by Year</h2>
                <span class="collapse-icon" id="stackedChartIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="stackedChartSection">
                <canvas id="stackedChart"></canvas>
            </div>
        </div>

        <!-- Line Chart -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('lineChartSection')">
                <h2>Total Compensation Trend</h2>
                <span class="collapse-icon" id="lineChartIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="lineChartSection">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('detailedTableSection')">
                <h2>Detailed Breakdown</h2>
                <span class="collapse-icon" id="detailedTableIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="detailedTableSection">
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th class="text-right">Base Salary</th>
                                <th class="text-right">Bonus</th>
                                <th class="text-right">Initial RSUs</th>
                                <th class="text-right">Refresher RSUs</th>
                                <th class="text-right">Stock Price</th>
                                <th class="text-right">Stock Value</th>
                                <th class="text-right"><strong>Total Comp</strong></th>
                                <th class="text-right" id="afterTaxHeader" style="display: none;"><strong>After Tax</strong></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Levels.fyi Comparison -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('levelsFyiSection')">
                <h2>ðŸ“Š Compare with Market Data</h2>
                <span class="collapse-icon" id="levelsFyiIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="levelsFyiSection">
                <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 15px;">
                    Use the interactive chart below to compare your compensation with market data from levels.fyi
                </p>
                <iframe 
                    src="https://www.levels.fyi/charts_embed.html?company=Google&track=Software%20Engineer&hide_selector=false" 
                    height="500" 
                    style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px;" 
                    frameborder="0" 
                    scrolling="auto">
                </iframe>
            </div>
        </div>

        <div class="note">
            <strong>Note:</strong> This calculator shows your initial grant vesting schedule (40/30/20/10) plus any refresher grants you add. 
            Refresher RSUs typically vest over 4 years (25% per year by default, adjustable). The calculator assumes each refresher grant starts 
            vesting in the year it's granted and continues vesting in subsequent years. For example, a Year 2 refresher will vest in Years 2, 3, 
            and 4. Ask your recruiter for the specific refresher amounts and vesting schedules!
            <br><br>
            <strong>ðŸ’¾ Auto-Save:</strong> Your inputs are automatically saved in your browser and will persist when you refresh the page.
            <button onclick="resetCalculator()" style="margin-left: 10px; padding: 5px 15px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                Reset to Defaults
            </button>
        </div>
    </div>

    <script>
        function resetCalculator() {
            if (confirm('Are you sure you want to reset all values to defaults? This cannot be undone.')) {
                localStorage.removeItem('databricksCompCalc');
                location.reload();
            }
        }

        function getVestingSchedule() {
            const scheduleType = document.getElementById('vestingSchedule').value;
            if (scheduleType === 'front') {
                return [0.40, 0.30, 0.20, 0.10];
            } else {
                return [0.25, 0.25, 0.25, 0.25];
            }
        }

        // 2024 Federal tax brackets
        const taxBrackets = {
            single: [
                { rate: 10, min: 0, max: 11600 },
                { rate: 12, min: 11601, max: 47150 },
                { rate: 22, min: 47151, max: 100525 },
                { rate: 24, min: 100526, max: 191950 },
                { rate: 32, min: 191951, max: 243725 },
                { rate: 35, min: 243726, max: 609350 },
                { rate: 37, min: 609351, max: Infinity }
            ],
            married: [
                { rate: 10, min: 0, max: 23200 },
                { rate: 12, min: 23201, max: 94300 },
                { rate: 22, min: 94301, max: 201050 },
                { rate: 24, min: 201051, max: 383900 },
                { rate: 32, min: 383901, max: 487450 },
                { rate: 35, min: 487451, max: 731200 },
                { rate: 37, min: 731201, max: Infinity }
            ],
            head: [
                { rate: 10, min: 0, max: 16550 },
                { rate: 12, min: 16551, max: 63100 },
                { rate: 22, min: 63101, max: 100500 },
                { rate: 24, min: 100501, max: 191950 },
                { rate: 32, min: 191951, max: 243700 },
                { rate: 35, min: 243701, max: 609350 },
                { rate: 37, min: 609351, max: Infinity }
            ]
        };

        function formatTaxRange(min, max) {
            const formatNum = (val) => '$' + Math.round(val).toLocaleString();
            if (max === Infinity) {
                return 'Over ' + formatNum(min - 1);
            }
            return formatNum(min) + ' to ' + formatNum(max);
        }

        function updateFederalTaxBrackets() {
            const filingStatus = document.getElementById('filingStatus').value;
            const federalTaxRate = document.getElementById('federalTaxRate');
            const currentValue = federalTaxRate.value;
            
            const brackets = taxBrackets[filingStatus];
            
            federalTaxRate.innerHTML = brackets.map(bracket => 
                `<option value="${bracket.rate}">${bracket.rate}% - ${formatTaxRange(bracket.min, bracket.max)}</option>`
            ).join('');
            
            // Try to restore previous selection or default to first option
            if (currentValue && federalTaxRate.querySelector(`option[value="${currentValue}"]`)) {
                federalTaxRate.value = currentValue;
            }
            
            saveInputs();
            updateDisplay();
        }
        
        let stackedChart, lineChart;

        // Save inputs to localStorage
        function saveInputs() {
            const inputs = [
                'baseSalaryYear1', 'bonusYear1',
                'baseSalaryYear2', 'bonusYear2',
                'baseSalaryYear3', 'bonusYear3',
                'baseSalaryYear4', 'bonusYear4',
                'stockYear1', 'stockYear2', 'stockYear3', 'stockYear4', 'stockGrowth',
                'initialGrant', 'vestingSchedule', 'refresherYear2', 'refresherYear3', 'refresherYear4', 'refresherVesting',
                'filingStatus', 'federalTaxRate', 'stateTaxRate', 'otherTaxRate'
            ];
            
            const values = {};
            inputs.forEach(id => {
                const element = document.getElementById(id);
                values[id] = element.value;
            });
            
            // Handle checkbox separately
            values['enableTax'] = document.getElementById('enableTax').checked;
            
            localStorage.setItem('databricksCompCalc', JSON.stringify(values));
        }

        // Load inputs from localStorage
        function loadInputs() {
            const saved = localStorage.getItem('databricksCompCalc');
            if (saved) {
                try {
                    const values = JSON.parse(saved);
                    Object.keys(values).forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            if (id === 'enableTax') {
                                element.checked = values[id];
                            } else {
                                element.value = values[id];
                            }
                        }
                    });
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString();
        }

        function calculateComp() {
            const baseSalaries = [
                parseInt(document.getElementById('baseSalaryYear1').value) || 0,
                parseInt(document.getElementById('baseSalaryYear2').value) || 0,
                parseInt(document.getElementById('baseSalaryYear3').value) || 0,
                parseInt(document.getElementById('baseSalaryYear4').value) || 0
            ];

            const bonusPercents = [
                parseFloat(document.getElementById('bonusYear1').value) || 0,
                parseFloat(document.getElementById('bonusYear2').value) || 0,
                parseFloat(document.getElementById('bonusYear3').value) || 0,
                parseFloat(document.getElementById('bonusYear4').value) || 0
            ];

            const initialGrant = parseFloat(document.getElementById('initialGrant').value) || 0;
            const vestingSchedule = getVestingSchedule();
            
            const stockPrices = [
                parseFloat(document.getElementById('stockYear1').value),
                parseFloat(document.getElementById('stockYear2').value),
                parseFloat(document.getElementById('stockYear3').value),
                parseFloat(document.getElementById('stockYear4').value)
            ];

            const refresherGrants = [
                0, // Year 1 - no refresher
                parseFloat(document.getElementById('refresherYear2').value),
                parseFloat(document.getElementById('refresherYear3').value),
                parseFloat(document.getElementById('refresherYear4').value)
            ];

            const refresherVestingPercent = parseFloat(document.getElementById('refresherVesting').value) / 100;

            // Tax calculation
            const enableTax = document.getElementById('enableTax').checked;
            const federalTaxRate = parseFloat(document.getElementById('federalTaxRate').value) / 100;
            const stateTaxRate = parseFloat(document.getElementById('stateTaxRate').value) / 100;
            const otherTaxRate = parseFloat(document.getElementById('otherTaxRate').value) / 100;
            const totalTaxRate = enableTax ? (federalTaxRate + stateTaxRate + otherTaxRate) : 0;

            const years = [];
            
            for (let i = 0; i < 4; i++) {
                const currentBaseSalary = baseSalaries[i];
                const bonus = currentBaseSalary * (bonusPercents[i] / 100);
                
                // Initial grant vesting
                const initialSharesVested = initialGrant * vestingSchedule[i];
                
                // Refresher vesting - each refresher vests over time
                let refresherSharesVested = 0;
                
                // Year 2: only year 2 refresher vests (first year)
                // Year 3: year 2 refresher (2nd year) + year 3 refresher (1st year)
                // Year 4: year 2 refresher (3rd year) + year 3 refresher (2nd year) + year 4 refresher (1st year)
                if (i >= 1) { // Year 2+
                    refresherSharesVested += refresherGrants[i] * refresherVestingPercent; // Current year's refresher
                }
                if (i >= 2) { // Year 3+
                    refresherSharesVested += refresherGrants[i-1] * refresherVestingPercent; // Last year's refresher
                }
                if (i >= 3) { // Year 4
                    refresherSharesVested += refresherGrants[i-2] * refresherVestingPercent; // 2 years ago refresher
                }
                
                const totalSharesVested = initialSharesVested + refresherSharesVested;
                const stockValue = totalSharesVested * stockPrices[i];
                const totalComp = currentBaseSalary + bonus + stockValue;
                const afterTaxComp = Math.round(totalComp * (1 - totalTaxRate));
                
                years.push({
                    year: i + 1,
                    baseSalary: Math.round(currentBaseSalary),
                    bonus: Math.round(bonus),
                    initialSharesVested: Math.round(initialSharesVested),
                    refresherSharesVested: Math.round(refresherSharesVested),
                    stockPrice: stockPrices[i],
                    stockValue: Math.round(stockValue),
                    totalComp: Math.round(totalComp),
                    afterTaxComp: afterTaxComp
                });
            }
            
            return years;
        }

        function updateDisplay() {
            const data = calculateComp();
            const enableTax = document.getElementById('enableTax').checked;
            
            // Update summary cards
            document.getElementById('year1Total').textContent = formatCurrency(data[0].totalComp);
            document.getElementById('year4Total').textContent = formatCurrency(data[3].totalComp);
            
            const fourYearTotal = data.reduce((sum, year) => sum + year.totalComp, 0);
            document.getElementById('fourYearTotal').textContent = formatCurrency(fourYearTotal);
            document.getElementById('avgAnnual').textContent = formatCurrency(fourYearTotal / 4);

            // Show/hide after-tax values in summary cards
            if (enableTax) {
                document.getElementById('year1TotalAfterTax').textContent = 'After tax: ' + formatCurrency(data[0].afterTaxComp);
                document.getElementById('year4TotalAfterTax').textContent = 'After tax: ' + formatCurrency(data[3].afterTaxComp);
                const fourYearAfterTax = data.reduce((sum, year) => sum + year.afterTaxComp, 0);
                document.getElementById('fourYearTotalAfterTax').textContent = 'After tax: ' + formatCurrency(fourYearAfterTax);
                document.getElementById('avgAnnualAfterTax').textContent = 'After tax: ' + formatCurrency(fourYearAfterTax / 4);
            } else {
                document.getElementById('year1TotalAfterTax').textContent = '';
                document.getElementById('year4TotalAfterTax').textContent = '';
                document.getElementById('fourYearTotalAfterTax').textContent = '';
                document.getElementById('avgAnnualAfterTax').textContent = '';
            }

            // Show/hide after-tax column in table
            const afterTaxHeader = document.getElementById('afterTaxHeader');
            afterTaxHeader.style.display = enableTax ? '' : 'none';
            
            // Update table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = data.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td class="text-right">${formatCurrency(row.baseSalary)}</td>
                    <td class="text-right">${formatCurrency(row.bonus)}</td>
                    <td class="text-right">${row.initialSharesVested}</td>
                    <td class="text-right">${row.refresherSharesVested}</td>
                    <td class="text-right">$${row.stockPrice}</td>
                    <td class="text-right">${formatCurrency(row.stockValue)}</td>
                    <td class="text-right"><strong>${formatCurrency(row.totalComp)}</strong></td>
                    ${enableTax ? `<td class="text-right"><strong>${formatCurrency(row.afterTaxComp)}</strong></td>` : ''}
                </tr>
            `).join('');
            
            // Update charts
            updateCharts(data);
        }

        function updateCharts(data) {
            const labels = data.map(d => `Year ${d.year}`);
            const enableTax = document.getElementById('enableTax').checked;
            
            // Stacked Bar Chart
            if (stackedChart) stackedChart.destroy();
            const stackedCtx = document.getElementById('stackedChart').getContext('2d');
            
            const datasets = [
                {
                    label: 'Base Salary',
                    data: data.map(d => d.baseSalary),
                    backgroundColor: '#3b82f6',
                    stack: 'pre-tax'
                },
                {
                    label: 'Bonus',
                    data: data.map(d => d.bonus),
                    backgroundColor: '#10b981',
                    stack: 'pre-tax'
                },
                {
                    label: 'Stock Value',
                    data: data.map(d => d.stockValue),
                    backgroundColor: '#8b5cf6',
                    stack: 'pre-tax'
                }
            ];

            // Add after-tax bar as separate grouped bar if tax is enabled
            if (enableTax) {
                datasets.push({
                    label: 'After Tax',
                    data: data.map(d => d.afterTaxComp),
                    backgroundColor: '#ef4444',
                    stack: 'after-tax'
                });
            }

            stackedChart = new Chart(stackedCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: { stacked: false }, // Group bars instead of stacking
                        y: { 
                            stacked: true, // Stack within each group
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Line Chart
            if (lineChart) lineChart.destroy();
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            
            const lineDatasets = [{
                label: 'Total Compensation',
                data: data.map(d => d.totalComp),
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }];

            // Add after-tax line if tax is enabled
            if (enableTax) {
                lineDatasets.push({
                    label: 'After Tax Compensation',
                    data: data.map(d => d.afterTaxComp),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 3,
                    borderDash: [10, 5],
                    tension: 0.4,
                    fill: true
                });
            }

            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: lineDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update display values as inputs change
        function setupInputListeners() {
            const inputs = [
                'bonusYear1', 'bonusYear2', 'bonusYear3', 'bonusYear4',
                'initialGrant', 'vestingSchedule', 'refresherYear2', 'refresherYear3', 'refresherYear4', 'refresherVesting',
                'enableTax', 'federalTaxRate', 'stateTaxRate', 'otherTaxRate'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', function() {
                    saveInputs();
                    updateDisplay();
                });
            });

            // Filing status changes the tax brackets
            document.getElementById('filingStatus').addEventListener('change', function() {
                updateFederalTaxBrackets();
            });

            // Special handling for stock inputs
            const stockInputs = ['stockYear1', 'stockYear2', 'stockYear3', 'stockYear4'];
            stockInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', function() {
                    saveInputs();
                    updateDisplay();
                });
            });

            // Special handling for stock growth - auto-calculate Years 2-4
            const stockGrowthInput = document.getElementById('stockGrowth');
            const stockYear1Input = document.getElementById('stockYear1');
            
            function applyStockGrowth() {
                const year1Price = parseFloat(stockYear1Input.value) || 0;
                const growthPercent = parseFloat(stockGrowthInput.value) || 0;
                const growthMultiplier = 1 + (growthPercent / 100);
                
                // Only auto-update if growth is not zero
                if (growthPercent !== 0) {
                    document.getElementById('stockYear2').value = Math.round(year1Price * growthMultiplier);
                    document.getElementById('stockYear3').value = Math.round(year1Price * Math.pow(growthMultiplier, 2));
                    document.getElementById('stockYear4').value = Math.round(year1Price * Math.pow(growthMultiplier, 3));
                    saveInputs();
                    updateDisplay();
                }
            }

            stockGrowthInput.addEventListener('input', function() {
                applyStockGrowth();
                saveInputs();
            });

            // Auto-calculate base salary with 3% raise for years 2-4
            const baseSalaryYear1Input = document.getElementById('baseSalaryYear1');
            const baseSalaryYear2Input = document.getElementById('baseSalaryYear2');
            const baseSalaryYear3Input = document.getElementById('baseSalaryYear3');
            const baseSalaryYear4Input = document.getElementById('baseSalaryYear4');

            function applyBaseSalaryRaises() {
                const year1Salary = parseFloat(baseSalaryYear1Input.value) || 0;

                // Year 2 = Year 1 * 1.03
                const year2Salary = Math.round(year1Salary * 1.03);
                baseSalaryYear2Input.value = year2Salary;
                
                // Year 3 = Year 2 * 1.03
                const year3Salary = Math.round(year2Salary * 1.03);
                baseSalaryYear3Input.value = year3Salary;
                
                // Year 4 = Year 3 * 1.03
                baseSalaryYear4Input.value = Math.round(year3Salary * 1.03);
                
                saveInputs();
                updateDisplay();
            }

            baseSalaryYear1Input.addEventListener('input', function() {
                applyBaseSalaryRaises();
            });
            
            baseSalaryYear2Input.addEventListener('input', function() {
                // When Year 2 changes, update Years 3 and 4
                const year2Salary = parseFloat(baseSalaryYear2Input.value) || 0;
                baseSalaryYear3Input.value = Math.round(year2Salary * 1.03);
                baseSalaryYear4Input.value = Math.round(year2Salary * 1.03 * 1.03);
                saveInputs();
                updateDisplay();
            });
            
            baseSalaryYear3Input.addEventListener('input', function() {
                // When Year 3 changes, update Year 4
                const year3Salary = parseFloat(baseSalaryYear3Input.value) || 0;
                baseSalaryYear4Input.value = Math.round(year3Salary * 1.03);
                saveInputs();
                updateDisplay();
            });
            
            baseSalaryYear4Input.addEventListener('input', function() {
                // Year 4 is independent, just save and update
                saveInputs();
                updateDisplay();
            });
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId.replace('Section', 'Icon'));
            
            section.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        // Initialize
        loadInputs();
        updateFederalTaxBrackets(); // Populate tax brackets on load
        setupInputListeners();
        updateDisplay();
    </script>
</body>
</html>
